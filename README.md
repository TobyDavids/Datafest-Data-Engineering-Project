# Datafest-Data-Engineering-Project

-- SETTING WAREHOUSE AND DATABASE AND SCHEMA
USE WAREHOUSE DFA23;
USE DATABASE DFA23RAWDATA;
USE SCHEMA DATADYNASTY;



--DROP THE WRONG ETL FOR PEST DATA
DROP TABLE PESTDATARAW;

--STAGING CODE TO MOVE DATA FROM RAWDATA TO DATA DYNASTY (CHANGE JUST THE TABLE NAME)
CREATE OR REPLACE TABLE datadynasty.PESTDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.PESTDATARAW;

--CHECKING FOR NULLS
SELECT * FROM DATADYNASTY.PESTDATARAW
WHERE PEST_DESCRIPTION IS NULL
--Over 10k nulls present in pest_description column

SELECT * FROM DATADYNASTY.PESTDATARAW
WHERE PEST_SEVERITY IS NULL
--No nulls in Pest_severity column

--PEST TABLE CLEANING

--STEP 1 OF CLEANING - REPLACE NULL VALUES with N/A
UPDATE PESTDATARAW
SET PEST_DESCRIPTION = 'N/A'
WHERE PEST_DESCRIPTION IS NULL;

--STEP 2 OF CLEANING - CHANGE DATATYPES

--FOURTH STAGE OF CLEANING | IF VALUE IS IN DECIMAL (FLOAT)
-- IF VALUE HAS NO DECIMAL ITS SMALL LIKE 2 DIGITS(SMALLINT)
-- IF VALUE HAS NO DECIMAL BUT MORE THAN ONE DIGIT (BIGINT)

-- Add a new column with the correct datatype
ALTER TABLE PESTDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE PESTDATARAW SET NEW_TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE PESTDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE PESTDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;

--Checking Timestamp Datatype
SELECT COLUMN_NAME, DATA_TYPE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'PESTDATARAW' AND COLUMN_NAME = 'TIMESTAMP';

--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES
SELECT COUNT(*)
FROM PESTDATARAW 
--2,097,138 rows

--Drop Duplicates
DELETE FROM PESTDATARAW 
WHERE (PEST_DESCRIPTION, PEST_SEVERITY, PEST_TYPE, TIMESTAMP) IN
(
    SELECT PEST_DESCRIPTION, PEST_SEVERITY, PEST_TYPE, TIMESTAMP
    FROM PESTDATARAW
    GROUP BY 1, 2, 3, 4
    HAVING COUNT(*) > 1
)
AND (TIMESTAMP, PEST_DESCRIPTION, PEST_SEVERITY, PEST_TYPE) NOT IN
(
    SELECT MIN(TIMESTAMP), PEST_DESCRIPTION, PEST_SEVERITY, PEST_TYPE
    FROM PESTDATARAW
    GROUP BY PEST_DESCRIPTION, PEST_SEVERITY, PEST_TYPE
    HAVING COUNT(*) > 1
);

--54,731 duplicate rows. 




--TABLE 5- SENSOR DATA

--DROP THE WRONG ETL FOR SENSOR DATA
DROP TABLE SENSORDATARAW;

--STAGING CODE TO MOVE DATA FROM RAWDATA TO DATA DYNASTY (CHANGE JUST THE TABLE NAME)
CREATE OR REPLACE TABLE datadynasty.SENSORDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.SENSORDATARAW;

--CHECKING FOR NULLS
SELECT * FROM DATADYNASTY.SENSORDATARAW
WHERE TEMPERATURE IS NULL OR TEMPERATURE = 'NA'
--Over 479.4k NA present in TEMPERATURE column

SELECT * FROM DATADYNASTY.SENSORDATARAW
WHERE HUMIDITY IS NULL OR HUMIDITY = 'NA'
--Over 480.2k NA present in HUMIDITY column

SELECT * FROM DATADYNASTY.SENSORDATARAW
WHERE SOIL_MOISTURE IS NULL OR SOIL_MOISTURE = 'NA'
--479.4k NA present in SOIL_MOISTURE column

SELECT * FROM DATADYNASTY.SENSORDATARAW
WHERE LIGHT_INTENSITY IS NULL OR LIGHT_INTENSITY = 'NA'
--480.1k NA present in LIGHT_INTENSITY column

SELECT * FROM DATADYNASTY.SENSORDATARAW
WHERE BATTERY_LEVEL IS NULL OR BATTERY_LEVEL = 'NA'
--0 NULL present in BATTERY_LEVEL column

--REPLACE NULLS WITH AVERAGE IN TEMP, HUMIDITY, SOIL_MOISTURE, & LIGHT_INTENSITY

--Updating Humidity column with Mean values only for NA records
UPDATE SENSORDATARAW
SET HUMIDITY = (
    SELECT ROUND(AVG(CAST(HUMIDITY AS DECIMAL(5, 2))), 2) 
    FROM SENSORDATARAW 
    WHERE HUMIDITY != 'NA'
)
WHERE HUMIDITY = 'NA';


--Updating Temperature column with Mean values only for NA records
UPDATE SENSORDATARAW
SET TEMPERATURE = (
    SELECT ROUND(AVG(CAST(TEMPERATURE AS DECIMAL(5, 2))), 2) 
    FROM SENSORDATARAW 
    WHERE TEMPERATURE != 'NA'
)
WHERE TEMPERATURE = 'NA';

--Updating Soil_Moisture column with Mean values only for NA records
UPDATE SENSORDATARAW
SET SOIL_MOISTURE = (
    SELECT ROUND(AVG(CAST(SOIL_MOISTURE AS DECIMAL(5, 2))), 2) 
    FROM SENSORDATARAW 
    WHERE SOIL_MOISTURE != 'NA'
)
WHERE SOIL_MOISTURE = 'NA';

--Updating the LIGHT_INTENSITY column with Mean values only for NA records
UPDATE SENSORDATARAW
SET LIGHT_INTENSITY = (
    SELECT AVG(CAST(LIGHT_INTENSITY AS INTEGER))
    FROM SENSORDATARAW 
    WHERE LIGHT_INTENSITY != 'NA'
)
WHERE LIGHT_INTENSITY = 'NA';


--STEP 2 OF CLEANING - CHANGE DATATYPES

--Datatype changes for Timestamp
-- Add a new column with the correct data type
ALTER TABLE SENSORDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE SENSORDATARAW SET NEW_TIMESTAMP = TRY_TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

UPDATE SENSORDATARAW SET NEW_TIMESTAMP = TRY_TO_TIMESTAMP(REPLACE(TIMESTAMP, '"', ''), 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE SENSORDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE SENSORDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;


--Datatype change for Temperature, Humidity, Battery Level & Soil Mositure

-- Add new columns with the correct data type
ALTER TABLE SENSORDATARAW
ADD COLUMN NEW_TEMPERATURE DECIMAL(5, 2);

ALTER TABLE SENSORDATARAW
ADD COLUMN NEW_SOIL_MOISTURE DECIMAL(5, 2);

ALTER TABLE SENSORDATARAW
ADD COLUMN NEW_HUMIDITY DECIMAL(5, 2);

ALTER TABLE SENSORDATARAW
ADD COLUMN NEW_BATTERY_LEVEL DECIMAL(5, 2);

ALTER TABLE SENSORDATARAW
ADD COLUMN NEW_LIGHT_INTENSITY INTEGER;

-- Update the new columns with the converted data
UPDATE SENSORDATARAW
SET 
  NEW_TEMPERATURE = TRY_CAST(TEMPERATURE AS DECIMAL(5, 2));

UPDATE SENSORDATARAW
SET 
  NEW_SOIL_MOISTURE = TRY_CAST(SOIL_MOISTURE AS DECIMAL(5, 2));
  
UPDATE SENSORDATARAW
SET 
  NEW_HUMIDITY = TRY_CAST(HUMIDITY AS DECIMAL(5, 2));

UPDATE SENSORDATARAW
SET 
  NEW_BATTERY_LEVEL = TRY_CAST(BATTERY_LEVEL AS DECIMAL(5, 2));

UPDATE SENSORDATARAW
SET 
    NEW_LIGHT_INTENSITY = TRY_CAST(LIGHT_INTENSITY AS INTEGER);
    
-- Drop the old columns
   ALTER TABLE SENSORDATARAW
   DROP COLUMN TEMPERATURE;

   ALTER TABLE SENSORDATARAW
   DROP COLUMN SOIL_MOISTURE;

   ALTER TABLE SENSORDATARAW
   DROP COLUMN HUMIDITY;

   ALTER TABLE SENSORDATARAW
   DROP COLUMN BATTERY_LEVEL;

   ALTER TABLE SENSORDATARAW
   DROP COLUMN LIGHT_INTENSITY;

-- Rename the new columns to replace the old ones
   ALTER TABLE SENSORDATARAW
   RENAME COLUMN NEW_TEMPERATURE TO TEMPERATURE;

   ALTER TABLE SENSORDATARAW
   RENAME COLUMN NEW_SOIL_MOISTURE TO SOIL_MOISTURE;

   ALTER TABLE SENSORDATARAW
   RENAME COLUMN NEW_HUMIDITY TO HUMIDITY;
   
   ALTER TABLE SENSORDATARAW 
   RENAME COLUMN NEW_BATTERY_LEVEL TO BATTERY_LEVEL;

   ALTER TABLE SENSORDATARAW
   RENAME COLUMN NEW_LIGHT_INTENSITY TO LIGHT_INTENSITY;


--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

-- Check for duplicates and list them
SELECT
  TEMPERATURE,
  SOIL_MOISTURE,
  HUMIDITY,
  BATTERY_LEVEL,
  LIGHT_INTENSITY,
  TIMESTAMP
FROM SENSORDATARAW
GROUP BY
  TEMPERATURE,
  SOIL_MOISTURE,
  HUMIDITY,
  BATTERY_LEVEL,
  LIGHT_INTENSITY,
  TIMESTAMP
HAVING COUNT(*) > 1;
-- no Duplicates



-- TABLE SOILED DATA RAW
DROP TABLE SOILDATARAW

--STAGING CODE TO MOVE DATA FROM RAWDATA TO DATA DYNASTY (CHANGE JUST THE TABLE NAME)
CREATE OR REPLACE TABLE DATADYNASTY.SOILDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.SOILDATARAW;

--REPLACE NULLS WITH AVERAGE IN SOIL COMP, SOIL MOISTURE, SOIL PH, NITRO_LEVEL, PHOSPHORUS_LEVEL, ORG_MATTER

--Updating Soil_comp column with Mean values only for NA records
UPDATE SOILDATARAW
SET SOIL_COMP = (
    SELECT ROUND(AVG(CAST(SOIL_COMP AS DECIMAL(5, 2))), 2) 
    FROM SOILDATARAW 
    WHERE SOIL_COMP != 'NA'
)
WHERE SOIL_COMP = 'NA';
--104,242 rows updated

--Updating SOIL_MOISTURE column with Mean values only for NA records
UPDATE SOILDATARAW
SET SOIL_MOISTURE = (
    SELECT ROUND(AVG(CAST(SOIL_MOISTURE AS DECIMAL(5, 2))), 2) 
    FROM SOILDATARAW 
    WHERE SOIL_MOISTURE != 'NA'
)
WHERE SOIL_MOISTURE = 'NA';
--104,888 updated

--Updating Soil_PH column with Mean values only for NA records
UPDATE SOILDATARAW
SET SOIL_PH = (
    SELECT ROUND(AVG(CAST(SOIL_PH AS DECIMAL(4, 2))), 2) 
    FROM SOILDATARAW 
    WHERE SOIL_PH != 'NA'
)
WHERE SOIL_PH = 'NA';
--104,659 updated

--Updating the Nitrogen_level column with Mean values only for NA records
UPDATE SOILDATARAW
SET NITROGEN_LEVEL = (
    SELECT ROUND(AVG(CAST(NITROGEN_LEVEL AS DECIMAL(5, 2))), 2) 
    FROM SOILDATARAW 
    WHERE NITROGEN_LEVEL != 'NA' OR NITROGEN_LEVEL IS NOT NULL
)
WHERE NITROGEN_LEVEL = 'NA' OR NITROGEN_LEVEL IS NULL;
--104,567 UPDATED 

--Updating the Phosphorus_Level column with Mean values only for NA records
UPDATE SOILDATARAW
SET PHOSPHORUS_LEVEL = (
    SELECT ROUND(AVG(CAST(PHOSPHORUS_LEVEL AS DECIMAL(5, 2))), 2) 
    FROM SOILDATARAW 
    WHERE PHOSPHORUS_LEVEL != 'NA'
)
WHERE PHOSPHORUS_LEVEL = 'NA';
--104,446 UPDATED

--Updating the ORGANIC_MATTER column with Mean values only for NA records
UPDATE SOILDATARAW
SET ORGANIC_MATTER = (
    SELECT ROUND(AVG(CAST(ORGANIC_MATTER AS DECIMAL(5, 2))), 2) 
    FROM SOILDATARAW 
    WHERE ORGANIC_MATTER != 'NA'
)
WHERE ORGANIC_MATTER = 'NA';
--104,783 UPDATED 

--STEP 2 OF CLEANING - CHANGE DATATYPES


--Datatype changes for Timestamp
-- Add a new column with the correct data type
ALTER TABLE SOILDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE SOILDATARAW
SET TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'MM/DD/YYYY HH24:MI')::TIMESTAMP_NTZ;

UPDATE SOILDATARAW SET NEW_TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE SOILDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE SOILDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;


--Datatype change for SOIL COMP, SOIL MOISTURE, SOIL PH, NITRO_LEVEL, PHOSPHORUS_LEVEL, ORG_MATTER
-- Add new columns with the correct data type
ALTER TABLE SOILDATARAW
ADD COLUMN NEW_SOIL_COMP DECIMAL(5, 2);

ALTER TABLE SOILDATARAW
ADD COLUMN NEW_SOIL_MOISTURE DECIMAL(5, 2);

ALTER TABLE SOILDATARAW
ADD COLUMN NEW_SOIL_PH DECIMAL(4, 2);

ALTER TABLE SOILDATARAW
ADD COLUMN NEW_NITROGEN_LEVEL DECIMAL(5, 2); 

ALTER TABLE SOILDATARAW
ADD COLUMN NEW_PHOSPHORUS_LEVEL DECIMAL(5, 2);

ALTER TABLE SOILDATARAW
ADD COLUMN NEW_ORGANIC_MATTER DECIMAL(5, 2);

-- Update the new columns with the converted data
UPDATE SOILDATARAW
SET 
    NEW_SOIL_COMP = ROUND(TRY_CAST(SOIL_COMP AS DECIMAL(5, 2)), 2);
    
UPDATE SOILDATARAW
SET   
    NEW_SOIL_MOISTURE = ROUND(TRY_CAST(SOIL_MOISTURE AS DECIMAL(5, 2)), 2);
    
UPDATE SOILDATARAW
SET 
  NEW_SOIL_PH = ROUND(TRY_CAST(SOIL_PH AS DECIMAL(4, 2)), 2);

UPDATE SOILDATARAW
SET 
  NEW_NITROGEN_LEVEL = ROUND(TRY_CAST(NITROGEN_LEVEL AS DECIMAL(5, 2)), 2);
  
UPDATE SOILDATARAW
SET 
  NEW_PHOSPHORUS_LEVEL = ROUND(TRY_CAST(PHOSPHORUS_LEVEL AS DECIMAL(5, 2)), 2);

UPDATE SOILDATARAW
SET 
    NEW_ORGANIC_MATTER = ROUND(TRY_CAST(ORGANIC_MATTER AS DECIMAL(5, 2)), 2);


-- DROP OLD COLUMNS
ALTER TABLE SOILDATARAW
DROP COLUMN SOIL_COMP;
   
ALTER TABLE SOILDATARAW
DROP COLUMN SOIL_MOISTURE;

ALTER TABLE SOILDATARAW
DROP COLUMN SOIL_PH;

ALTER TABLE SOILDATARAW
DROP COLUMN NITROGEN_LEVEL;

ALTER TABLE SOILDATARAW
DROP COLUMN PHOSPHORUS_LEVEL;

ALTER TABLE SOILDATARAW
DROP COLUMN ORGANIC_MATTER;

-- Rename the new columns to replace the old ones
   ALTER TABLE SOILDATARAW
   RENAME COLUMN NEW_SOIL_COMP TO SOIL_COMP;

   ALTER TABLE SOILDATARAW
   RENAME COLUMN NEW_SOIL_MOISTURE TO SOIL_MOISTURE;

    ALTER TABLE SOILDATARAW
    RENAME COLUMN NEW_SOIL_PH TO SOIL_PH;

    ALTER TABLE SOILDATARAW
    RENAME COLUMN NEW_NITROGEN_LEVEL TO NITROGEN_LEVEL;

    ALTER TABLE SOILDATARAW
    RENAME COLUMN NEW_PHOSPHORUS_LEVEL TO PHOSPHORUS_LEVEL;

    ALTER TABLE SOILDATARAW 
    RENAME COLUMN NEW_ORGANIC_MATTER TO ORGANIC_MATTER;

--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

-- Check for duplicates and list them
-- Check for duplicates based on specific columns
--WITH DuplicateRows AS (
    SELECT
        SOIL_COMP,
        SOIL_MOISTURE,
        SOIL_PH,
        NITROGEN_LEVEL,
        PHOSPHORUS_LEVEL,
        ORGANIC_MATTER,
        TIMESTAMP,
        COUNT(*) AS row_count
    FROM
        SOILDATARAW
    GROUP BY
        SOIL_COMP,
        SOIL_MOISTURE,
        SOIL_PH,
        NITROGEN_LEVEL,
        PHOSPHORUS_LEVEL,
        ORGANIC_MATTER,
        TIMESTAMP
    HAVING
        COUNT(*) > 1;
--NO duplicates based on the timestamp


--TABLE WEATHERRAWDATA

--STAGING CODE TO MOVE DATA FROM RAW DATA TO DATA DYNASTY
CREATE OR REPLACE TABLE DATADYNASTY.WEATHERDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.WEATHERDATARAW;


-- Update the table to replace "CLAAR" with "CLEAR" in the WEATHER_CONDITION column
UPDATE WEATHERDATARAW
SET WEATHER_CONDITION = REPLACE(WEATHER_CONDITION, 'Claar', 'Clear');

-- Update the table to replace "Party Cloudy" with "Partly Cloudy" in the WEATHER_CONDITION column
UPDATE WEATHERDATARAW
SET WEATHER_CONDITION = REPLACE(WEATHER_CONDITION, 'Party Cloudy', 'Partly Cloudy');

--Confirm Update
SELECT DISTINCT WEATHER_CONDITION
FROM WEATHERDATARAW;
--9 distinct categories returned

--REPLACE NULLS WITH AVERAGE IN WIND_SPEED, AND PRECIPITATION

--Updating WIND_SPEED column with Mean values only for NA records
UPDATE WEATHERDATARAW
SET WIND_SPEED = (
    SELECT ROUND(AVG(CAST(WIND_SPEED AS DECIMAL)), 2) 
    FROM WEATHERDATARAW 
    WHERE WIND_SPEED != 'NA'
)
WHERE WIND_SPEED = 'NA';
--210,148 updated

--Updating the PRECIPITATION column with Mean values only for NA records
UPDATE WEATHERDATARAW
SET PRECIPITATION = (
    SELECT ROUND(AVG(CAST(PRECIPITATION AS DECIMAL)), 2) 
    FROM WEATHERDATARAW 
    WHERE PRECIPITATION != 'NA'
)
WHERE PRECIPITATION = 'NA';
--209,703 updated


--STEP 2 OF CLEANING - CHANGE DATATYPES


--Datatype changes for Timestamp
-- Add a new column with the correct data type
ALTER TABLE WEATHERDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE WEATHERDATARAW
SET TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'MM/DD/YYYY HH24:MI')::TIMESTAMP_NTZ;

UPDATE WEATHERDATARAW SET NEW_TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE WEATHERDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE WEATHERDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;


--Datatype change for WIND_SPEED & PRECIPITATION

-- Add new columns with the correct data type
ALTER TABLE WEATHERDATARAW
ADD COLUMN NEW_WIND_SPEED DECIMAL(5, 2);

ALTER TABLE WEATHERDATARAW
ADD COLUMN NEW_PRECIPITATION DECIMAL(5, 2);


-- Update the new columns with the converted data
UPDATE WEATHERDATARAW
SET 
    NEW_WIND_SPEED = TRY_CAST(WIND_SPEED AS DECIMAL(5, 2));
    
UPDATE WEATHERDATARAW
SET   
    NEW_PRECIPITATION = TRY_CAST(PRECIPITATION AS DECIMAL(5, 2));
    

-- DROP OLD COLUMNS
   
ALTER TABLE WEATHERDATARAW
DROP COLUMN WIND_SPEED;

ALTER TABLE WEATHERDATARAW
DROP COLUMN PRECIPITATION;


-- Rename the new columns to replace the old ones
   ALTER TABLE WEATHERDATARAW
   RENAME COLUMN NEW_WIND_SPEED TO WIND_SPEED;

   ALTER TABLE WEATHERDATARAW
   RENAME COLUMN NEW_PRECIPITATION TO PRECIPITATION;

  
--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

-- Check for duplicates and list them
-- Delete duplicates from the WEATHERDATARAW table based on all columns
DELETE FROM WEATHERDATARAW
WHERE (WIND_SPEED, PRECIPITATION, WEATHER_CONDITION, TIMESTAMP) IN (
    SELECT WIND_SPEED, PRECIPITATION, WEATHER_CONDITION, TIMESTAMP
    FROM WEATHERDATARAW
    GROUP BY WIND_SPEED, PRECIPITATION, WEATHER_CONDITION, TIMESTAMP
    HAVING COUNT(*) > 1
);
--4,393 duplicates DROPPED


--LOCATIONDATARAW TABLE CLEANING

--DROP WRONG STAGED DATA
DROP TABLE LOCATIONDATARAW;

--STAGING CODE TO MOVE DATA FROM RAW DATA TO DATA DYNASTY
CREATE OR REPLACE TABLE DATADYNASTY.LOCATIONDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.LOCATIONDATARAW;

-- Delete rows where all columns are NULL from the LOCATIONDATARAW table
DELETE FROM LOCATIONDATARAW
WHERE
  SENSOR_ID IS NULL
  AND LOCATION_NAME IS NULL
  AND LATITUDE IS NULL
  AND LONGITUDE IS NULL
  AND ELEVATION IS NULL;
--168,266 null records dropped.

SELECT DISTINCT LONGITUDE
FROM LOCATIONDATARAW
WHERE LONGITUDE IS NULL OR LONGITUDE = 'NA'

SELECT DISTINCT ELEVATION
FROM LOCATIONDATARAW
WHERE ELEVATION IS NULL OR ELEVATION = 'NA'

SELECT DISTINCT REGION
FROM LOCATIONDATARAW
WHERE REGION IS NULL OR REGION = 'NA'
--No null or NA recorded

SELECT *
FROM LOCATIONDATARAW
--STEP 2 OF CLEANING - CHANGE DATATYPES

--Datatype change for LATITUDE, LONGITUDE, & ELEVATION

-- Add new columns with the correct data type
ALTER TABLE LOCATIONDATARAW
ADD COLUMN NEW_LATITUDE DECIMAL(8, 6);

ALTER TABLE LOCATIONDATARAW
ADD COLUMN NEW_LONGITUDE DECIMAL(9, 6);

ALTER TABLE LOCATIONDATARAW
ADD COLUMN NEW_ELEVATION DECIMAL(8, 2);

-- Update the new columns with the converted data
UPDATE LOCATIONDATARAW
SET 
    NEW_LATITUDE = TRY_CAST(LATITUDE AS DECIMAL(8, 6));
    
UPDATE LOCATIONDATARAW
SET   
    NEW_LONGITUDE = TRY_CAST(LONGITUDE AS DECIMAL(9, 6));
    
UPDATE LOCATIONDATARAW
SET   
    NEW_ELEVATION = TRY_CAST(ELEVATION AS DECIMAL(8, 2));
    
-- DROP OLD COLUMNS
   
ALTER TABLE LOCATIONDATARAW
DROP COLUMN LATITUDE;

ALTER TABLE LOCATIONDATARAW
DROP COLUMN LONGITUDE;

ALTER TABLE LOCATIONDATARAW
DROP COLUMN ELEVATION;

-- Rename the new columns to replace the old ones
   ALTER TABLE LOCATIONDATARAW
   RENAME COLUMN NEW_LATITUDE TO LATITUDE;

   ALTER TABLE LOCATIONDATARAW
   RENAME COLUMN NEW_LONGITUDE TO LONGITUDE;

   ALTER TABLE LOCATIONDATARAW
   RENAME COLUMN NEW_ELEVATION TO ELEVATION;
  
--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

-- Check for duplicates and list them
    SELECT LATITUDE, LONGITUDE, ELEVATION, LOCATION_NAME, SENSOR_ID
    FROM LOCATIONDATARAW
    GROUP BY LATITUDE, LONGITUDE, ELEVATION, LOCATION_NAME, SENSOR_ID
    HAVING COUNT(*) > 1;
--NO DUPLICATES FOUND


--CROPDATARAW TABLE CLEANING

--DROP WRONG STAGED DATA
DROP TABLE CROPDATARAW;

--STAGING CODE TO MOVE DATA FROM RAW DATA TO DATA DYNASTY
CREATE OR REPLACE TABLE DATADYNASTY.CROPDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.CROPDATARAW;

-- Delete rows where all columns are NULL from the CROPDATARAW table
DELETE FROM CROPDATARAW
WHERE
  CROP_TYPE IS NULL
  AND CROP_YIELD IS NULL
  AND GROWTH_STAGE IS NULL
  AND PEST_ISSUE IS NULL
  AND TIMESTAMP IS NULL;
--5 NULL records dropped.

SELECT CROP_TYPE
FROM CROPDATARAW
WHERE CROP_TYPE IS NULL OR CROP_TYPE = 'NA'

SELECT CROP_YIELD
FROM CROPDATARAW
WHERE CROP_YIELD IS NULL OR CROP_YIELD = 'NA'

SELECT GROWTH_STAGE
FROM CROPDATARAW
WHERE GROWTH_STAGE IS NULL OR GROWTH_STAGE = 'NA';

SELECT PEST_ISSUE
FROM CROPDATARAW
WHERE PEST_ISSUE IS NULL OR PEST_ISSUE = 'NA'
--210.6k records of NA from Growth Stage, Pest Issue and Crop Yield
--Since there are no records for these that is tied to a crop, we drop it.

-- Drop the record with 'NA' in the PEST_ISSUE column
DELETE FROM CROPDATARAW
WHERE PEST_ISSUE = 'NA' AND CROP_YIELD = 'NA' AND GROWTH_STAGE = 'NA';
--52,945 records dropped

-- Update the table to replace "Wheaat" with "Wheat" in the CROP TYPE column
UPDATE CROPDATARAW
SET CROP_TYPE = REPLACE(CROP_TYPE, 'Wheaat', 'Wheat');

-- Update the table to replace "Cron" with "Corn" in the CROP TYPE column
UPDATE CROPDATARAW
SET CROP_TYPE = REPLACE(CROP_TYPE, 'Cron', 'Corn');


--STEP 2 OF CLEANING - CHANGE DATATYPES

--Datatype change for CROP YIELD

-- Add new columns with the correct data type
ALTER TABLE CROPDATARAW
ADD COLUMN NEW_CROP_YIELD DECIMAL(8, 2);

-- Update the new columns with the converted data
UPDATE CROPDATARAW
SET 
    NEW_CROP_YIELD = TRY_CAST(CROP_YIELD AS DECIMAL(8, 2));
        
-- DROP OLD COLUMNS  
ALTER TABLE CROPDATARAW
DROP COLUMN CROP_YIELD;

-- Rename the new columns to replace the old ones
ALTER TABLE CROPDATARAW
RENAME COLUMN NEW_CROP_YIELD TO CROP_YIELD;


--DATATYPE CHANGE FOR TIMESTAMP
--Add a new column with the correct data type
ALTER TABLE CROPDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE CROPDATARAW
SET TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'MM/DD/YYYY HH24:MI')::TIMESTAMP_NTZ;

UPDATE CROPDATARAW SET NEW_TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE CROPDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE CROPDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;


--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

--DROP DUPLICATES
DELETE FROM CROPDATARAW
WHERE (TIMESTAMP, GROWTH_STAGE, CROP_TYPE, PEST_ISSUE, CROP_YIELD) IN (
    SELECT TIMESTAMP, GROWTH_STAGE, CROP_TYPE, PEST_ISSUE, CROP_YIELD
    FROM CROPDATARAW
    GROUP BY TIMESTAMP, GROWTH_STAGE, CROP_TYPE, PEST_ISSUE, CROP_YIELD
    HAVING COUNT(*) > 1
);

--IRRIGATIONDATA TABLE CLEANING

--DROP WRONG STAGED DATA
DROP TABLE IRRIGATIONDATARAW;

--STAGING CODE TO MOVE DATA FROM RAW DATA TO DATA DYNASTY
CREATE OR REPLACE TABLE DATADYNASTY.IRRIGATIONDATARAW AS
SELECT * FROM DFA23RAWDATA.RAWDATA.IRRIGATIONDATARAW;

-- Delete rows where all columns are NULL from the IRRIGATIONDATARAW table
DELETE FROM IRRIGATIONDATARAW
WHERE
  SENSOR_ID IS NULL
  AND TIMESTAMP IS NULL
  AND IRRIGATION_METHOD IS NULL
  AND IRRIGATION_DURATION_MIN IS NULL
  AND WATER_SOURCE IS NULL;
--0 NULL records dropped.

SELECT SENSOR_ID
FROM IRRIGATIONDATARAW
WHERE SENSOR_ID IS NULL OR SENSOR_ID = 'NA'

SELECT TIMESTAMP
FROM IRRIGATIONDATARAW
WHERE TIMESTAMP IS NULL OR TIMESTAMP = 'NA'

SELECT IRRIGATION_METHOD
FROM IRRIGATIONDATARAW
WHERE IRRIGATION_METHOD IS NULL OR IRRIGATION_METHOD = 'NA';

SELECT WATER_SOURCE
FROM IRRIGATIONDATARAW
WHERE WATER_SOURCE IS NULL OR WATER_SOURCE = 'NA';
--104.6K RECORDS with NA

SELECT IRRIGATION_DURATION_MIN
FROM IRRIGATIONDATARAW
WHERE IRRIGATION_DURATION_MIN IS NULL OR IRRIGATION_DURATION_MIN = 'NA';
--104.5k records of NA from IRRIGATION_DURATION_MIN

--Replaced NA with Average values in the IRRIGATION_DURATION_MIN
--Updating WIND_SPEED column with Mean values only for NA records
UPDATE IRRIGATIONDATARAW
SET IRRIGATION_DURATION_MIN = (
    SELECT AVG(CAST(IRRIGATION_DURATION_MIN AS INTEGER))
    FROM IRRIGATIONDATARAW 
    WHERE IRRIGATION_DURATION_MIN != 'NA'
)
WHERE IRRIGATION_DURATION_MIN = 'NA';
--104.5k RECORDS updated

--Checking for Distinct Values
SELECT DISTINCT WATER_SOURCE, IRRIGATION_METHOD
FROM IRRIGATIONDATARAW;

-- Update the table to replace "Driip" with "Drip" in the IRRIGATION_METHOD column
UPDATE IRRIGATIONDATARAW
SET IRRIGATION_METHOD = REPLACE(IRRIGATION_METHOD, 'Driip', 'Drip');

-- Update the table to replace "Spinkler" with "Sprinkler" in the IRRIGATION_METHOD column
UPDATE IRRIGATIONDATARAW
SET IRRIGATION_METHOD = REPLACE(IRRIGATION_METHOD, 'Spinkler', 'Sprinkler');


-- Update the table to replace "Rivver" with "River" in the WATER_SOURCE column
UPDATE IRRIGATIONDATARAW
SET WATER_SOURCE = REPLACE(WATER_SOURCE, 'Rivver', 'River');

-- Update the table to replace "Wel" with "Well" in the WATER_SOURCE column
UPDATE IRRIGATIONDATARAW
SET WATER_SOURCE = REPLACE(WATER_SOURCE, 'Wel', 'Well');



--STEP 2 OF CLEANING - CHANGE DATATYPES

--Datatype change for IRRIGATION_DURATION_MIN
-- Add new columns with the correct data type
ALTER TABLE IRRIGATIONDATARAW
ADD COLUMN NEW_IRRIGATION_DURATION_MIN INTEGER;

-- Update the new columns with the converted data
UPDATE IRRIGATIONDATARAW
SET 
    NEW_IRRIGATION_DURATION_MIN = TRY_CAST(IRRIGATION_DURATION_MIN AS INTEGER);
        
-- DROP OLD COLUMNS  
ALTER TABLE IRRIGATIONDATARAW
DROP COLUMN IRRIGATION_DURATION_MIN;

-- Rename the new columns to replace the old ones
ALTER TABLE IRRIGATIONDATARAW
RENAME COLUMN NEW_IRRIGATION_DURATION_MIN TO IRRIGATION_DURATION_MIN;


--DATATYPE CHANGE FOR TIMESTAMP
--Add a new column with the correct data type
ALTER TABLE IRRIGATIONDATARAW ADD COLUMN NEW_TIMESTAMP TIMESTAMP;

-- Update the new column with the converted data
UPDATE IRRIGATIONDATARAW
SET TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'MM/DD/YYYY HH24:MI')::TIMESTAMP_NTZ;

UPDATE IRRIGATIONDATARAW SET NEW_TIMESTAMP = TO_TIMESTAMP(TIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF3');

-- Drop the old column
ALTER TABLE IRRIGATIONDATARAW DROP COLUMN TIMESTAMP;

-- Rename the new column to replace the old one
ALTER TABLE IRRIGATIONDATARAW RENAME COLUMN NEW_TIMESTAMP TO TIMESTAMP;


--STEP 3 OF CLEANING -CHECK FOR AND REMOVE DUPLICATES

--DROP DUPLICATES
--CHECKING DUPLICATES
    SELECT TIMESTAMP, SENSOR_ID, IRRIGATION_DURATION_MIN, IRRIGATION_METHOD, WATER_SOURCE
    FROM IRRIGATIONDATARAW
    GROUP BY TIMESTAMP, SENSOR_ID, IRRIGATION_DURATION_MIN, IRRIGATION_METHOD, WATER_SOURCE
    HAVING COUNT(*) > 1;
    --NO DUPLICATES RECORDED
